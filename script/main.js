(()=>{"use strict";let e=[],t=(...t)=>{console.log(t),e.push(t)},i=(...t)=>{console.error(t),e.push(t)};const n=document.getElementById("canvas"),a=n.getContext("2d"),d=e=>e*Math.PI/180,l="https://script.google.com/macros/s/AKfycbwXhRv0JoSfB2uzCTbHfH8NVvv2u3tF_0EyjBe_-xLdbPbkljIYc3oFKrWHLIPg3FtM/exec";let c,o,s,r,m,u,p,f=!1,_=e=>f=e;function g(e){s=e}function h(e){r=e}class y{static OFFSET_X=2e3;static OFFSET_Y=2e3;static local_x=0;static local_y=0;static local_size=1;static clickFlag=[];static pinRenderFlag=[];static lineCustomRenderFlag=[];static cx=e=>(y.OFFSET_X+y.local_x+e)*y.local_size;static cy=e=>(y.OFFSET_Y+y.local_y+e)*y.local_size;static render(){t("Render Updated"),y.clear();for(let e=0;e<o.length;e++){let t=[],i=[];const n=o[e];for(let e of n.pid)for(let n=0;n<c.length;n++)c[n].pid==e&&(t.push(c[n].x),i.push(c[n].y));y.lineRender(t,i,n.color)}if(null!=y.pinRenderFlag)for(let e of y.pinRenderFlag)y.pinRender(e.x,e.y,e.r,e.c);for(const e of y.lineCustomRenderFlag)y.lineRender(e.x,e.y,e.c)}static clear(){t("Canvas Clear"),a.clearRect(0,0,n.width,n.height),a.fillStyle="rgb(230, 230, 230)",a.fillRect(0,0,2*y.OFFSET_X,2*y.OFFSET_Y)}static lineRender(e,i,n){t("RenderLine",e,i,n),y.strokeWidth(10),y.strokeStyle(n),a.beginPath(),a.moveTo(y.cx(e[0]),y.cy(i[0]));for(let t=1;t<e.length;t++)a.lineTo(y.cx(e[t]),y.cy(i[t]));a.stroke()}static pinRender(e,i,n,l){t("RenderPin",e,i,n,l),y.fillStyle(l),a.beginPath(),a.arc(y.cx(e),y.cy(i),n,d(0),d(360),!1),a.fill()}static dragstart(e){t("Start Drag"),p=!0,m=e.offsetX,u=e.offsetY}static dragupdate(e){if(p){if(t("Update Drag"),null==m||null==u)return;let i=1/y.local_size;y.local_x+=(e.offsetX-m)*i,y.local_y+=(e.offsetY-u)*i,m=e.offsetX,u=e.offsetY,y.render()}}static dragend(e){t("End Drag"),p=!1}static wheelzoom(e){t("Update WheelZoom"),e.preventDefault();let i=-.002*e.deltaY,n=y.local_size;y.local_size+=i;let a=y.OFFSET_X,d=y.OFFSET_Y;y.local_x=(y.local_x-a/n)*(n/y.local_size)+a/y.local_size,y.local_y=(y.local_y-d/n)*(n/y.local_size)+d/y.local_size,t("L",y.local_x,y.local_y),y.render()}static addClickEvent=(e,t,i,a,d)=>{y.clickFlag.push([e-i,t-i,e+i,t+i,a]),n.addEventListener("click",(d=>{let l=n.getBoundingClientRect(),c=(d.clientX-l.left)*(n.width/l.width),o=(d.clientY-l.top)*(n.height/l.height);c>y.cx(e-i)&&o>y.cy(t-i)&&c<y.cx(e+i)&&o<y.cy(t+i)&&a(e,t,i)}))};static addPinFlag=(e,t,i)=>y.pinRenderFlag.push({x:e,y:t,r:7,c:i});static addLineFlag=(e,t,i)=>y.lineCustomRenderFlag.push({x:e,y:t,c:i});static resetLineFlag=()=>y.lineCustomRenderFlag=[];static strokeStyle=e=>a.strokeStyle=e;static strokeWidth=e=>a.lineWidth=e;static fillStyle=e=>a.fillStyle=e}class v{static get(e,t,i){let n=[...c],a={},d={},l=[];for(n.forEach((e=>{a[e.pid]=1/0})),a[e.pid]=0;n.length>0;){n.sort(((e,t)=>a[e.pid]-a[t.pid]));let e=n.shift();o.filter((t=>t.pid.includes(e.pid)&&t.type===i)).forEach((t=>{t.pid.map((e=>c.find((t=>t.pid===e)))).filter((t=>t!==e)).forEach((i=>{let n=(c=e,o=i,Math.sqrt(Math.pow(c.x-o.x,2)+Math.pow(c.y-o.y,2)));var c,o;a[e.pid]+n<a[i.pid]&&(a[i.pid]=a[e.pid]+n,d[i.pid]=e,l.push(t))}))}))}let s=[],r=t;for(;r!==e;){let e,t=d[r.pid],n=l.find((e=>e.pid.includes(r.pid)&&e.pid.includes(t.pid))),c=10*(a[r.pid]-a[t.pid]);e="train"==i?Math.ceil(c/420):0,s.unshift({distance:Math.ceil(c),min:e,direction:n,from:t,to:r,line:n}),r=t}let m,u=10*a[t.pid];return m="train"==i?Math.ceil(u/420):0,{distance:Math.round(u),min:m,direction:s}}}let w=document.getElementById("directionresults");class E{static clear(){w.innerHTML=""}static add(e){w.insertAdjacentHTML("afterbegin",e)}}class S{static directionResultCard(e,t,i,n,a,d=""){let l;switch(e){case"train":l="t";break;case"car":l="c"}return`<div class="di_res"><div><div class="i ${l}"></div><div><h3>${String(t)}分 / ${i}m</h3><p>${n}</p></div></div><div><a href="javascript:${a}(${d});" class="s text">開始</a></div></div>`}static direcitonSubCard(e,t,i){return`<div class="t"><div class="tl"><span>${e}</span></div><div class="mt"><h3>乗り換え</h3><p>${t} >>> ${i}<br><span>駅によっては乗り換えが不可能な場合もございます。ご了承ください。</span></p></div></div>`}static direcitonMainCard(e,t,i,n,a){return`<div class="t"><div class="tl" style="border-right: 0.5vw solid ${n};"><span>${String(e)}分</span></div><div class="mt"><h3>${t} (${String(a)}m)</h3><p>${i}</p></div></div>`}}class I{static info_image=document.getElementById("info_image");static info_description=document.getElementById("info_description");static info_title=document.getElementById("info_title");static set(e){null!=e.src?I.info_image.src=e.src:I.info_image.src="",I.info_title.textContent=e.name,null!=e.description?I.info_description.textContent=e.description:I.info_description.textContent=""}}let L=document.getElementById("routeGuide");class F{static clear(){L.innerHTML=""}static add(e){for(let t=0;t<e.direction.length;t++){const i=e.direction[t];e.direction.length-1!=t?(L.insertAdjacentHTML("beforeend",S.direcitonMainCard(i.min,i.line.name,`${i.from.name} >>> ${i.to.name}`,i.line.color,i.distance)),L.insertAdjacentHTML("beforeend",S.direcitonSubCard(i.to.name,i.line.name,e.direction[t+1].line.name))):L.insertAdjacentHTML("beforeend",S.direcitonMainCard(i.min,i.line.name,`${i.from.name} >>> ${i.to.name}`,i.line.color,i.distance))}}static show(){L.classList.remove("hide")}static hide(){L.classList.add("hide")}}class b{static _form=document.getElementById("addnewf");static pin_=document.getElementById("pin_addform");static pin_name=document.getElementById("name_addp");static pin_x=document.getElementById("x_addp");static pin_z=document.getElementById("z_addp");static pin_id_before=document.getElementById("id_before_addp");static pin_id_after=document.getElementById("id_after_addp");static pin_id_custom=document.getElementById("id_custom_addp");static pin_description=document.getElementById("description_addp");static pin_image=document.getElementById("image_addp");static nulc=(e,t)=>null==e||null==e||""==e||"_"==e?t:e;static show(){b._form?.classList.remove("hide")}static cancel(){b._form?.classList.add("hide")}static sendPin(){document.getElementById("regist_load")?.classList.remove("hide"),t(b);let e={target:"pin",data:[String(b.nulc(b.pin_name.value,"名称なし")),parseInt(b.pin_x.value),parseInt(b.pin_z.value),String(b.nulc(b.nulc(b.pin_id_custom.value,b.pin_id_before.value+"_"+b.pin_id_after.value),crypto.randomUUID())),String(b.nulc(b.pin_description.value,"")),String(b.nulc(b.pin_image.value,""))]};const n=JSON.stringify(e);fetch(l,{redirect:"follow",method:"POST",body:n,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then((e=>e.json())).then((e=>{t(e),location.reload()})).catch((e=>i(e)))}}class x{static _form=document.getElementById("addnewl");static line_=document.getElementById("line_addform");static line_name=document.getElementById("name_addl");static line_color=document.getElementById("color_addl");static line_path=document.getElementById("path_addl");static line_id_before=document.getElementById("id_before_addl");static line_id_after=document.getElementById("id_after_addl");static line_id_custom=document.getElementById("id_custom_addl");static banner=document.getElementById("edit_mode_nav");static pl=[];static pla=e=>x.pl.push(e);static nulc=(e,t)=>null==e||null==e||""==e||"_"==e?t:e;static editStart(){_(!0),x.banner?.classList.remove("hide"),h(void 0),g(void 0)}static editCancel(){_(!1),x.banner?.classList.add("hide")}static show(){x._form?.classList.remove("hide"),x.line_path.value=x.pl.join(",")}static cancel(){x._form?.classList.add("hide")}static sendLine(){document.getElementById("regist_load")?.classList.remove("hide"),t(x);let e={target:"line",data:[String(x.nulc(x.line_name.value,"名称なし")),String(x.nulc(x.line_color.value,"black")),String(x.nulc(x.line_path.value,"")),String(x.nulc(x.nulc(x.line_id_custom.value,x.line_id_before.value+"_"+x.line_id_after.value),crypto.randomUUID())),"train"]};const n=JSON.stringify(e);fetch(l,{redirect:"follow",method:"POST",body:n,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then((e=>e.json())).then((e=>{t(e),location.reload()})).catch((e=>i(e))),_(!1),x.banner?.classList.add("hide")}}let B,R=document.getElementById("pointList"),C=document.getElementById("fromPoint"),T=document.getElementById("toPoint"),$=document.getElementById("main"),M=document.getElementById("directions"),z=document.getElementById("information");function k(){t("Window Resized"),n.width=2*y.OFFSET_X,n.height=2*y.OFFSET_Y,n.style.width=String($.clientWidth)+"px",n.style.height=String($.clientHeight)+"px",y.render()}function O(){z.classList.remove("hide"),M.classList.add("hide")}(async function(){return fetch(l).then((function(e){return e.json()}))})().then((e=>{var i,a;t(e),i=function(e){let t=[],i=e.pin.slice(1);for(const e of i)t.push({name:String(e[0]),x:Number(e[1])/10,y:Number(e[2])/10,pid:String(e[3]),description:e[4],src:e[5]});return t}(e),c=i,a=function(e){let t=[],i=e.line.slice(1);for(const e of i)t.push({name:String(e[0]),color:String(e[1]),pid:String(e[2]).split(","),lid:String(e[3]),type:e[4]});return t}(e),o=a,c.forEach((e=>{R.insertAdjacentHTML("afterbegin",`<option value="${e.name}" id="pin_${e.pid}"></option>`),y.addClickEvent(e.x,e.y,10,(()=>{O(),null!=s&&(h(s),1==f&&(y.addLineFlag([r.x,e.x],[r.y,e.y],"#000000"),t(r,s),y.render())),1==f&&x.pla(e.pid),g(e),I.set(e)}),e.pid),y.addPinFlag(e.x,e.y,"#007bff")})),k(),window.onresize=k,n.addEventListener("mousedown",y.dragstart),n.addEventListener("mousemove",y.dragupdate),n.addEventListener("mouseup",y.dragend),n.addEventListener("wheel",y.wheelzoom),n.addEventListener("contextmenu",(e=>{}),!1),document.getElementById("splash")?.classList.add("hide")})),window.reverseft=function(){let e=C.value,t=T.value;C.value=t,T.value=e},window.outputresult=function(){if(""==C.value||""==T.value)return;let e,t;for(let t=0;t<c.length;t++)if(c[t].name===C.value){e=c[t];break}for(let e=0;e<c.length;e++)if(c[e].name===T.value){t=c[e];break}if(null!=e&&null!=t){let i;E.clear(),B=[],i=v.get(e,t,"train"),B.push(i);let n="";for(let e of i.direction)n+=e.line.name+"、";E.add(S.directionResultCard("train",i.min,i.distance,n,"startNavi","0"))}},window.startNavi=function(e){F.clear();let t=B[e];null!=t&&(F.add(t),F.show())},window.closeNavi=function(){F.clear()},window.dismiss_donate=function(){document.getElementById("marumasa_donation")?.remove()},window.tabDir=function(){M.classList.remove("hide"),z.classList.add("hide")},window.tabInfo=O,window.cancelAddForm=b.cancel,window.showAddForm=b.show,window.sendPin=b.sendPin,window.lineEditStart=x.editStart,window.lineEditCancel=x.editCancel,window.lineRegistForm=x.show,window.lineRegistCancel=x.cancel,window.lineRegistSend=x.sendLine,window.getLog=function(){location.href=URL.createObjectURL(new Blob([String(e)],{type:"application/octet-stream"}))}})();