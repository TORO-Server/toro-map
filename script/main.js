(()=>{"use strict";let t=[],e=(...e)=>{console.log(e),t.push(e)};const i=document.getElementById("canvas"),n=i.getContext("2d"),a=t=>t*Math.PI/180;let l,c,d,o,s;class r{static OFFSET_X=2e3;static OFFSET_Y=2e3;static local_x=0;static local_y=0;static local_size=1;static clickFlag=[];static pinRenderFlag=[];static lineRenderFlag=[];static cx=t=>(r.OFFSET_X+r.local_x+t)*r.local_size;static cy=t=>(r.OFFSET_Y+r.local_y+t)*r.local_size;static render(){e("Render Updated"),r.clear();for(let t=0;t<c.length;t++){let e=[],i=[];const n=c[t];for(let t of n.pid)for(let n=0;n<l.length;n++)l[n].pid==t&&(e.push(l[n].x),i.push(l[n].y));r.lineRender(e,i,n.color)}if(null!=r.pinRenderFlag)for(let t of r.pinRenderFlag)r.pinRender(t.x,t.y,t.r,t.c)}static clear(){e("Canvas Clear"),n.clearRect(0,0,i.width,i.height),n.fillStyle="rgb(230, 230, 230)",n.fillRect(0,0,2*r.OFFSET_X,2*r.OFFSET_Y)}static lineRender(t,i,a){e("RenderLine",t,i,a),r.strokeWidth(10),r.strokeStyle(a),n.beginPath(),n.moveTo(r.cx(t[0]),r.cy(i[0]));for(let e=1;e<t.length;e++)n.lineTo(r.cx(t[e]),r.cy(i[e]));n.stroke()}static pinRender(t,i,l,c){e("RenderPin",t,i,l,c),r.fillStyle(c),n.beginPath(),n.arc(r.cx(t),r.cy(i),l,a(0),a(360),!1),n.fill()}static dragstart(t){e("Start Drag"),s=!0,d=t.offsetX,o=t.offsetY}static dragupdate(t){if(s){if(e("Update Drag"),null==d||null==o)return;let i=1/r.local_size;r.local_x+=(t.offsetX-d)*i,r.local_y+=(t.offsetY-o)*i,d=t.offsetX,o=t.offsetY,r.render()}}static dragend(t){e("End Drag"),s=!1}static wheelzoom(t){e("Update WheelZoom"),t.preventDefault();let i=-.002*t.deltaY,n=r.local_size;r.local_size+=i;let a=r.OFFSET_X,l=r.OFFSET_Y;for(r.local_x=(r.local_x-a/n)*(n/r.local_size)+a/r.local_size,r.local_y=(r.local_y-l/n)*(n/r.local_size)+l/r.local_size;;)e("L",r.local_x,r.local_y);r.render()}static addClickEvent=(t,e,n,a,l)=>{r.clickFlag.push([t-n,e-n,t+n,e+n,a]),i.addEventListener("click",(l=>{let c=i.getBoundingClientRect(),d=(l.clientX-c.left)*(i.width/c.width),o=(l.clientY-c.top)*(i.height/c.height);d>r.cx(t-n)&&o>r.cy(e-n)&&d<r.cx(t+n)&&o<r.cy(e+n)&&a(t,e,n)}))};static addPinFlag=(t,e,i)=>r.pinRenderFlag.push({x:t,y:e,r:7,c:i});static strokeStyle=t=>n.strokeStyle=t;static strokeWidth=t=>n.lineWidth=t;static fillStyle=t=>n.fillStyle=t}class f{static get(t,e,i){let n=[...l],a={},d={},o=[];for(n.forEach((t=>{a[t.pid]=1/0})),a[t.pid]=0;n.length>0;){n.sort(((t,e)=>a[t.pid]-a[e.pid]));let t=n.shift();c.filter((e=>e.pid.includes(t.pid)&&e.type===i)).forEach((e=>{e.pid.map((t=>l.find((e=>e.pid===t)))).filter((e=>e!==t)).forEach((i=>{let n=(l=t,c=i,Math.sqrt(Math.pow(l.x-c.x,2)+Math.pow(l.y-c.y,2)));var l,c;a[t.pid]+n<a[i.pid]&&(a[i.pid]=a[t.pid]+n,d[i.pid]=t,o.push(e))}))}))}let s=[],r=e;for(;r!==t;){let t,e=d[r.pid],n=o.find((t=>t.pid.includes(r.pid)&&t.pid.includes(e.pid))),l=10*(a[r.pid]-a[e.pid]);t="train"==i?Math.ceil(l/420):0,s.unshift({distance:Math.ceil(l),min:t,direction:n,from:e,to:r,line:n}),r=e}let f,u=10*a[e.pid];return f="train"==i?Math.ceil(u/420):0,{distance:Math.round(u),min:f,direction:s}}}let u=document.getElementById("directionresults");class p{static clear(){u.innerHTML=""}static add(t){u.insertAdjacentHTML("afterbegin",t)}}class m{static directionResultCard(t,e,i,n,a,l=""){let c;switch(t){case"train":c="t";break;case"car":c="c"}return`<div class="di_res"><div><div class="i ${c}"></div><div><h3>${String(e)}分 / ${i}m</h3><p>${n}</p></div></div><div><a href="javascript:${a}(${l});" class="s text">開始</a></div></div>`}static direcitonSubCard(t,e,i){return`<div class="t"><div class="tl"><span>${t}</span></div><div class="mt"><h3>乗り換え</h3><p>${e} >>> ${i}<br><span>駅によっては乗り換えが不可能な場合もございます。ご了承ください。</span></p></div></div>`}static direcitonMainCard(t,e,i,n,a){return`<div class="t"><div class="tl" style="border-right: 0.5vw solid ${n};"><span>${String(t)}分</span></div><div class="mt"><h3>${e} (${String(a)}m)</h3><p>${i}</p></div></div>`}}class h{static info_image=document.getElementById("info_image");static info_description=document.getElementById("info_description");static info_title=document.getElementById("info_title");static set(t){null!=t.src?h.info_image.src=t.src:h.info_image.src="",h.info_title.textContent=t.name,null!=t.description?h.info_description.textContent=t.description:h.info_description.textContent=""}}let g=document.getElementById("routeGuide");class v{static clear(){g.innerHTML=""}static add(t){for(let e=0;e<t.direction.length;e++){const i=t.direction[e];t.direction.length-1!=e?(g.insertAdjacentHTML("beforeend",m.direcitonMainCard(i.min,i.line.name,`${i.from.name} >>> ${i.to.name}`,i.line.color,i.distance)),g.insertAdjacentHTML("beforeend",m.direcitonSubCard(i.to.name,i.line.name,t.direction[e+1].line.name))):g.insertAdjacentHTML("beforeend",m.direcitonMainCard(i.min,i.line.name,`${i.from.name} >>> ${i.to.name}`,i.line.color,i.distance))}}static show(){g.classList.remove("hide")}static hide(){g.classList.add("hide")}}function y(){return fetch("https://script.google.com/macros/s/AKfycbwezotBmCkcq8iNUn0F8Tu2Ft3g8O3lAZhzCYlsO5OcphxG_86ZGFw5mWjwkw0bvud-/exec").then((function(t){return t.json()}))}let _,w,E,F=document.getElementById("pointList"),S=document.getElementById("fromPoint"),x=document.getElementById("toPoint"),L=document.getElementById("main"),b=document.getElementById("directions"),R=document.getElementById("information");function T(){e("Window Resized"),i.width=2*r.OFFSET_X,i.height=2*r.OFFSET_Y,i.style.width=String(L.clientWidth)+"px",i.style.height=String(L.clientHeight)+"px",r.render()}function $(){R.classList.remove("hide"),b.classList.add("hide")}(async function(){let t=[],e=(await y()).pin.slice(1);for(const i of e)t.push({name:String(i[0]),x:Number(i[1])/10,y:Number(i[2])/10,pid:String(i[3]),description:i[4],src:i[5]});return t})().then((t=>{e(t),function(t){l=t}(t),async function(){let t=[],e=(await y()).line.slice(1);for(const i of e)t.push({name:String(i[0]),color:String(i[1]),pid:String(i[2]).split(","),lid:String(i[3]),type:i[4]});return t}().then((t=>{e(t),function(t){c=t}(t),l.forEach((t=>{F.insertAdjacentHTML("afterbegin",`<option value="${t.name}" id="pin_${t.pid}"></option>`),r.addClickEvent(t.x,t.y,10,(()=>{null!=_&&(w=_,$()),_=t,h.set(t)}),t.pid),r.addPinFlag(t.x,t.y,"#007bff")})),T(),window.onresize=T,i.addEventListener("mousedown",r.dragstart),i.addEventListener("mousemove",r.dragupdate),i.addEventListener("mouseup",r.dragend),i.addEventListener("wheel",r.wheelzoom),i.addEventListener("contextmenu",(t=>{}),!1)}))})),window.reverseft=function(){let t=S.value,e=x.value;S.value=e,x.value=t},window.outputresult=function(){if(""==S.value||""==x.value)return;let t,e;for(let e=0;e<l.length;e++)if(l[e].name===S.value){t=l[e];break}for(let t=0;t<l.length;t++)if(l[t].name===x.value){e=l[t];break}if(null!=t&&null!=e){let i;p.clear(),E=[],i=f.get(t,e,"train"),E.push(i);let n="";for(let t of i.direction)n+=t.line.name+"、";p.add(m.directionResultCard("train",i.min,i.distance,n,"startNavi","0"))}},window.startNavi=function(t){v.clear();let e=E[t];null!=e&&(v.add(e),v.show())},window.closeNavi=function(){v.clear()},window.dismiss_donate=function(){document.getElementById("marumasa_donation")?.remove()},window.tabDir=function(){b.classList.remove("hide"),R.classList.add("hide")},window.tabInfo=$,window.getLog=function(){location.href=URL.createObjectURL(new Blob([String(t)],{type:"application/octet-stream"}))}})();